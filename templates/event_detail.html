{% extends "layout.html" %}
{% block title %}{{ event.title }}{% endblock %}
{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('event_list') }}">Events</a></li>
    <li class="breadcrumb-item active">{{ event.title }}</li>
  </ol>
</nav>

<div class="row">
  <div class="col-lg-8 mb-4">
    <div class="dashboard-section">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
        <h1 class="mb-0" style="font-weight: 800;">{{ event.title }}</h1>
        <div>
          {% if event.requires_faculty_approval %}
          <span class="badge bg-warning"><i class="bi bi-exclamation-triangle me-1"></i>Requires Faculty Approval</span>
          {% endif %}
          {% if event.status == 'approved' %}
          <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Open for Booking</span>
          {% elif event.status == 'pending' %}
          <span class="badge bg-warning"><i class="bi bi-clock me-1"></i>Pending Approval</span>
          {% else %}
          <span class="badge bg-secondary">{{ event.status }}</span>
          {% endif %}
        </div>
      </div>

      {% if event.poster_path %}
      <img src="{{ url_for('serve_upload', filename=event.poster_path.split('/')[-1]) }}" class="img-fluid mb-4 w-100"
        style="border-radius: 12px; max-height: 400px; object-fit: cover;" alt="Event Poster">
      {% endif %}

      <div class="row mb-4">
        <div class="col-md-6">
          <div class="d-flex align-items-center mb-3">
            <div class="icon me-3"
              style="width: 48px; height: 48px; background: linear-gradient(135deg, #818cf8 0%, #4f46e5 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <i class="bi bi-calendar3 text-white" style="font-size: 1.2rem;"></i>
            </div>
            <div>
              <div class="small text-muted">Date & Time</div>
              <strong>{{ event.start_time.strftime('%B %d, %Y') }}</strong><br>
              <span class="text-muted">{{ event.start_time.strftime('%I:%M %p') }} - {{ event.end_time.strftime('%I:%M
                %p') }}</span>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex align-items-center mb-3">
            <div class="icon me-3"
              style="width: 48px; height: 48px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <i class="bi bi-geo-alt text-white" style="font-size: 1.2rem;"></i>
            </div>
            <div>
              <div class="small text-muted">Venue</div>
              <strong>{{ event.hall.name }}</strong><br>
              <span class="text-muted">{{ event.hall.location or 'Campus' }}</span>
            </div>
          </div>
        </div>
      </div>

      <h5 class="mb-3"><i class="bi bi-text-paragraph me-2"></i>About This Event</h5>
      <p class="mb-4">{{ event.description or 'No description provided.' }}</p>

      <div class="d-flex align-items-center">
        <div class="icon me-3"
          style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
          <i class="bi bi-person text-white"></i>
        </div>
        <div>
          <div class="small text-muted">Organized by</div>
          <strong>{{ event.organizer.full_name or event.organizer.email }}</strong>
        </div>
      </div>
    </div>

    {% if event.images %}
    <div class="dashboard-section mb-4">
      <h5 class="mb-3"><i class="bi bi-images me-2"></i>Event Gallery</h5>
      <div class="row g-3">
        {% for img in event.images %}
        <div class="col-6 col-md-4">
          <a href="{{ url_for('serve_upload', filename=img.image_path.split('/')[-1]) }}" target="_blank">
            <img src="{{ url_for('serve_upload', filename=img.image_path.split('/')[-1]) }}"
              class="img-fluid rounded shadow-sm hover-zoom" style="width: 100%; aspect-ratio: 4/3; object-fit: cover;"
              alt="Event Image">
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>

  <div class="col-lg-4 mb-4">
    <div class="dashboard-section mb-4">
      <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i>Event Details</h5>
      <ul class="list-unstyled mb-0">
        <li class="d-flex justify-content-between py-2 border-bottom">
          <span class="text-muted">Category</span>
          <strong>{{ event.category.name if event.category else 'General' }}</strong>
        </li>
        <li class="d-flex justify-content-between py-2 border-bottom">
          <span class="text-muted">Event Capacity</span>
          <strong>{{ event.capacity or 'Unlimited' }}</strong>
        </li>
        <li class="d-flex justify-content-between py-2 border-bottom">
          <span class="text-muted">Hall Capacity</span>
          <strong>{{ event.hall.capacity }}</strong>
        </li>
        <li class="d-flex justify-content-between py-2">
          <span class="text-muted">Faculty Approval</span>
          <strong>{{ 'Required' if event.requires_faculty_approval else 'Not Required' }}</strong>
        </li>
      </ul>
    </div>

    {% if event.invitation_path %}
    <div class="dashboard-section mb-4">
      <h5 class="mb-3"><i class="bi bi-file-earmark-text me-2"></i>Invitation</h5>
      <a href="{{ url_for('serve_upload', filename=event.invitation_path.split('/')[-1]) }}" target="_blank"
        class="btn btn-outline-primary w-100">
        <i class="bi bi-download me-2"></i>Download Invitation
      </a>
    </div>
    {% endif %}

    <div class="dashboard-section">
      <h5 class="mb-3"><i class="bi bi-ticket-perforated me-2"></i>Book Your Spot</h5>

      {% if current_user.is_authenticated %}
      {% if user_booking %}
      {% if user_booking.status == 'confirmed' %}
      <div class="alert alert-success d-flex align-items-center mb-3">
        <i class="bi bi-check-circle-fill me-2" style="font-size: 1.5rem;"></i>
        <div>
          <strong>You are going!</strong><br>
          Your booking is confirmed.
        </div>
      </div>
      <a href="{{ url_for('view_ticket', booking_id=user_booking.id) }}" target="_blank"
        class="btn btn-primary btn-lg w-100 mb-2">
        <i class="bi bi-file-pdf me-2"></i>Download Ticket
      </a>
      <div class="text-center small text-muted">Ticket ID: {{ user_booking.ticket_id[:8] }}...</div>
      {% elif user_booking.status == 'pending' %}
      <div class="alert alert-warning mb-0">
        <i class="bi bi-clock me-2"></i>Your booking is pending approval.
      </div>
      {% elif user_booking.status == 'cancelled' %}
      <div class="alert alert-danger mb-3">
        <i class="bi bi-x-circle me-2"></i>Your booking was cancelled.
      </div>
      {% set avail = available %}
      {% if avail is none or avail > 0 %}
      <form method="post" action="{{ url_for('book_event', event_id=event.id) }}">
        <button class="btn btn-outline-primary w-100" type="submit">
          Book Again
        </button>
      </form>
      {% endif %}
      {% endif %}
      {% else %}
      {% if event.status != 'approved' and current_user.role != 'admin' %}
      <div class="alert alert-warning mb-0">
        <i class="bi bi-exclamation-triangle me-2"></i>Event is not open for booking yet.
      </div>
      {% else %}
      {% set avail = available %}
      {% if avail is none %}
      <p class="mb-3"><i class="bi bi-infinity me-2"></i>Unlimited seats available</p>
      {% else %}
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span>Seats Available</span>
        <span class="badge {% if avail > 10 %}bg-success{% elif avail > 0 %}bg-warning{% else %}bg-danger{% endif %}"
          style="font-size: 1rem;">{{ avail }}</span>
      </div>
      {% if avail <= 0 %} <div class="alert alert-danger mb-0">
        <i class="bi bi-x-circle me-2"></i>Sorry, this event is sold out!
    </div>
    {% endif %}
    {% endif %}

    {% if avail is none or avail > 0 %}
    <form method="post" action="{{ url_for('book_event', event_id=event.id) }}">
      <button class="btn btn-success btn-lg w-100" type="submit">
        <i class="bi bi-ticket-perforated me-2"></i>Book Now
      </button>
    </form>
    <p class="small text-muted mt-3 mb-0">
      <i class="bi bi-info-circle me-1"></i>
      {% if event.requires_faculty_approval %}
      Booking requires faculty and organizer approval. You'll receive a confirmation email.
      {% else %}
      You'll receive a confirmation email with your ticket.
      {% endif %}
    </p>
    {% endif %}
    {% endif %}
    {% endif %}
    {% else %}
    <p class="mb-3">Please log in to book a ticket for this event.</p>
    <a href="{{ url_for('login') }}" class="btn btn-primary w-100">
      <i class="bi bi-box-arrow-in-right me-2"></i>Login to Book
    </a>
    <p class="small text-muted text-center mt-2 mb-0">
      Don't have an account? <a href="{{ url_for('register') }}">Register here</a>
    </p>
    {% endif %}
  </div>

  {% if current_user.is_authenticated and (current_user.role in ['organizer','admin'] and current_user.id ==
  event.organizer_id or current_user.role == 'admin') %}
  <div class="dashboard-section mt-4 mb-4">
    <h5 class="mb-3"><i class="bi bi-images me-2"></i>Event Gallery</h5>

    {% if event.images %}
    <div class="row g-2 mb-3">
      {% for img in event.images %}
      <div class="col-4">
        <a href="{{ url_for('serve_upload', filename=img.image_path.split('/')[-1]) }}" target="_blank">
          <img src="{{ url_for('serve_upload', filename=img.image_path.split('/')[-1]) }}" class="img-fluid rounded"
            style="aspect-ratio: 1/1; object-fit: cover;" alt="Event Image">
        </a>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-muted small">No images uploaded yet.</p>
    {% endif %}

    <form method="post" action="{{ url_for('upload_event_gallery', event_id=event.id) }}" enctype="multipart/form-data">
      <div class="mb-2">
        <label class="form-label small">Upload Photos</label>
        <input type="file" name="images" class="form-control form-control-sm" multiple accept="image/*" required>
      </div>
      <button class="btn btn-outline-primary btn-sm w-100"><i class="bi bi-upload me-1"></i>Upload Images</button>
    </form>
  </div>

  <div class="dashboard-section mt-4">
    <h5 class="mb-3"><i class="bi bi-gear me-2"></i>Manage Event</h5>
    <a href="{{ url_for('edit_event', event_id=event.id) }}" class="btn btn-outline-primary w-100 mb-2">
      <i class="bi bi-pencil me-2"></i>Edit Event
    </a>
    <a href="{{ url_for('organizer_bookings') }}" class="btn btn-outline-secondary w-100">
      <i class="bi bi-people me-2"></i>View Bookings
    </a>
  </div>
  {% endif %}
</div>
</div>
{% endblock %}